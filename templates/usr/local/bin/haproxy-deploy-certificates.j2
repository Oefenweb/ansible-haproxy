#!/usr/bin/env bash
#
# Ansible managed
#
# set -x;
set -e;
set -o pipefail;
#
thisFile="$(readlink -f "${0}")";
thisFilePath="$(dirname "${thisFile}")";

{% if haproxy_ssl_deploy_remove_existing | default(false) %}
rm -f "{{ haproxy_global_crt_base }}/*.pem";
{% endif %}

for dir in $(ls -d {{ haproxy_ssl_deploy_src_path | default('/etc/letsencrypt/live') }}/*/); do
  domain="$(basename $dir)";
  prefix="100";
  if [ $domain == "{{ inventory_hostname }}" ]; then
    prefix="000";
  fi

  cat ${dir}{{ haproxy_ssl_deploy_fullchain_name | default('fullchain.pem') }} ${dir}{{ haproxy_ssl_deploy_privkey_name | default('privkey.pem') }} > "{{ haproxy_global_crt_base }}/$prefix-$domain.pem";
done

systemctl reload haproxy;
